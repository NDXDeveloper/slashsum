# Makefile complet pour slashsum avec setup Rust
.PHONY: build test clean run help install release setup-rust setup-windows setup-dev build-windows build-all

# Variables
BINARY_NAME=slashsum
VERSION ?= $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME_VAL = $(shell date -u +%Y-%m-%dT%H:%M:%SZ)
GIT_COMMIT_VAL = $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Variables d'environnement pour Rust
export BUILD_VERSION=$(VERSION)
export BUILD_TIME=$(BUILD_TIME_VAL)
export GIT_COMMIT=$(GIT_COMMIT_VAL)

# =============================================================================
# SETUP ET INSTALLATION
# =============================================================================

check-rust: ## V√©rifier si Rust est install√©
	@if ! command -v rustc >/dev/null 2>&1; then \
		echo "‚ùå Rust n'est pas install√©"; \
		echo "üí° Lancez 'make setup-rust' pour l'installer"; \
		exit 1; \
	else \
		echo "‚úÖ Rust $(shell rustc --version)"; \
	fi

setup-rust: ## Installer Rust via rustup
	@echo "ü¶Ä Installation de Rust..."
	@if ! command -v rustc >/dev/null 2>&1; then \
		echo "üì• T√©l√©chargement et installation de rustup..."; \
		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y; \
		echo "üîÑ Rechargement de l'environnement..."; \
		. ~/.cargo/env; \
		echo "‚úÖ Rust install√© avec succ√®s"; \
	else \
		echo "‚úÖ Rust d√©j√† install√©"; \
	fi
	@echo "üîß Configuration des composants..."
	rustup component add clippy rustfmt
	@echo "üìã Versions install√©es:"
	@rustc --version
	@cargo --version
	@rustup --version

setup-windows: ## Installer les outils pour cross-compilation Windows
	@echo "ü™ü Installation des outils Windows..."
	@make check-rust
	@echo "üì• Installation de la target Windows..."
	rustup target add x86_64-pc-windows-gnu
	@echo "üîß Installation des outils de cross-compilation..."
	@if ! command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1; then \
		echo "üì¶ Installation de mingw-w64..."; \
		sudo apt update; \
		sudo apt install -y gcc-mingw-w64-x86-64; \
	else \
		echo "‚úÖ mingw-w64 d√©j√† install√©"; \
	fi
	@echo "‚úÖ Setup Windows termin√©"

setup-dev: ## Installer tous les outils de d√©veloppement
	@echo "üõ†Ô∏è  Installation compl√®te de l'environnement de d√©veloppement..."
	@make setup-rust
	@make setup-windows
	@echo "üîß Installation des outils additionnels..."
	@if ! command -v cargo-audit >/dev/null 2>&1; then \
		cargo install cargo-audit; \
	else \
		echo "‚úÖ cargo-audit d√©j√† install√©"; \
	fi
	@if ! command -v cargo-tarpaulin >/dev/null 2>&1; then \
		cargo install cargo-tarpaulin; \
	else \
		echo "‚úÖ cargo-tarpaulin d√©j√† install√©"; \
	fi
	@echo "üìã R√©sum√© de l'installation:"
	@echo "  ü¶Ä Rust: $(shell rustc --version 2>/dev/null || echo 'Non install√©')"
	@echo "  üì¶ Cargo: $(shell cargo --version 2>/dev/null || echo 'Non install√©')"
	@echo "  ü™ü Windows target: $(shell rustup target list --installed | grep x86_64-pc-windows-gnu || echo 'Non install√©')"
	@echo "  üîç Clippy: $(shell rustup component list --installed | grep clippy || echo 'Non install√©')"
	@echo "  üé® rustfmt: $(shell rustup component list --installed | grep rustfmt || echo 'Non install√©')"
	@echo "  üõ°Ô∏è  cargo-audit: $(shell command -v cargo-audit >/dev/null 2>&1 && echo 'Install√©' || echo 'Non install√©')"
	@echo "  üìä cargo-tarpaulin: $(shell command -v cargo-tarpaulin >/dev/null 2>&1 && echo 'Install√©' || echo 'Non install√©')"
	@echo "‚úÖ Environnement de d√©veloppement pr√™t!"

update-rust: ## Mettre √† jour Rust et ses composants
	@echo "üîÑ Mise √† jour de Rust..."
	rustup update
	rustup component add clippy rustfmt
	@echo "‚úÖ Rust mis √† jour"

# =============================================================================
# BUILD
# =============================================================================

build: check-rust ## Compiler le binaire Linux
	@echo "üî® Building $(BINARY_NAME) version $(VERSION)..."
	@echo "üìÖ Build time: $(BUILD_TIME_VAL)"
	@echo "üîó Git commit: $(GIT_COMMIT_VAL)"
	cargo build --release

build-local: check-rust build ## Build avec v√©rifications pour usage local

build-windows: ## Build pour Windows (avec v√©rifications)
	@echo "ü™ü Building for Windows..."
	@make check-rust
	@if ! rustup target list --installed | grep -q x86_64-pc-windows-gnu; then \
		echo "‚ùå Windows target manquante"; \
		echo "üí° Lancez 'make setup-windows' pour l'installer"; \
		exit 1; \
	fi
	@if ! command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1; then \
		echo "‚ùå Outils de cross-compilation manquants"; \
		echo "üí° Lancez 'make setup-windows' pour les installer"; \
		exit 1; \
	fi
	@export CC_x86_64_pc_windows_gnu=x86_64-w64-mingw32-gcc && \
	export CXX_x86_64_pc_windows_gnu=x86_64-w64-mingw32-g++ && \
	export AR_x86_64_pc_windows_gnu=x86_64-w64-mingw32-ar && \
	export CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc && \
	cargo build --release --target x86_64-pc-windows-gnu
	@echo "‚úÖ Windows build termin√©"

build-all: build build-windows ## Build pour toutes les plateformes
	@echo "üéâ All builds completed successfully!"
	@echo "üìÅ Binaires cr√©√©s:"
	@echo "  üêß Linux:   target/release/$(BINARY_NAME)"
	@echo "  ü™ü Windows: target/x86_64-pc-windows-gnu/release/$(BINARY_NAME).exe"
	@ls -la target/release/$(BINARY_NAME) 2>/dev/null || echo "  ‚ùå Linux binary manquant"
	@ls -la target/x86_64-pc-windows-gnu/release/$(BINARY_NAME).exe 2>/dev/null || echo "  ‚ùå Windows binary manquant"

debug: check-rust ## Compiler en mode debug
	@echo "üî® Building $(BINARY_NAME) version $(VERSION) (debug)..."
	cargo build

# =============================================================================
# TESTS
# =============================================================================

test: check-rust ## Lancer les tests basiques
	cargo test

test-all: check-rust ## Lancer tous les tests (y compris ignor√©s)
	@echo "üß™ Tests complets..."
	cargo test -- --include-ignored

test-verbose: check-rust ## Tests avec sortie d√©taill√©e
	@echo "üîç Tests verbeux..."
	cargo test -- --nocapture

test-performance: check-rust ## Tests de performance uniquement
	@echo "‚ö° Tests de performance..."
	cargo test --release -- --ignored --nocapture

test-coverage: check-rust ## Tests avec couverture de code
	@echo "üìä Tests avec couverture..."
	@if ! command -v cargo-tarpaulin >/dev/null 2>&1; then \
		echo "üì• Installation de cargo-tarpaulin..."; \
		cargo install cargo-tarpaulin; \
	fi
	cargo tarpaulin --verbose --all-features --workspace --timeout 120

test-windows: build-windows ## Tester le binaire Windows avec Wine
	@echo "üß™ Testing Windows binary..."
	@if command -v wine >/dev/null 2>&1; then \
		echo "üç∑ Test avec Wine:"; \
		wine target/x86_64-pc-windows-gnu/release/$(BINARY_NAME).exe --version; \
	else \
		echo "‚ö†Ô∏è  Wine non install√© - v√©rification basique:"; \
		file target/x86_64-pc-windows-gnu/release/$(BINARY_NAME).exe; \
	fi

test-files: build ## Tests avec fichiers r√©els
	@echo "üìÅ Tests avec fichiers r√©els..."
	@mkdir -p /tmp/slashsum_test
	@echo "Hello World!" > /tmp/slashsum_test/small.txt
	@dd if=/dev/zero of=/tmp/slashsum_test/medium.bin bs=1M count=1 2>/dev/null
	@touch /tmp/slashsum_test/empty.txt
	@echo "üß™ Test fichier petit..."
	@./target/release/$(BINARY_NAME) /tmp/slashsum_test/small.txt
	@echo "üß™ Test fichier vide..."
	@./target/release/$(BINARY_NAME) /tmp/slashsum_test/empty.txt
	@echo "üß™ Test fichier moyen..."
	@./target/release/$(BINARY_NAME) /tmp/slashsum_test/medium.bin
	@echo "üß™ Test option --save..."
	@./target/release/$(BINARY_NAME) /tmp/slashsum_test/small.txt --save
	@rm -rf /tmp/slashsum_test
	@echo "‚úÖ Tests fichiers termin√©s"

# =============================================================================
# QUALIT√â DE CODE
# =============================================================================

lint: check-rust ## V√©rifications avec Clippy
	@echo "üîç V√©rifications Clippy..."
	cargo clippy -- -D warnings

fmt: check-rust ## V√©rifier le formatage du code
	@echo "üé® V√©rification du formatage..."
	cargo fmt -- --check

fmt-fix: check-rust ## Corriger le formatage du code
	@echo "üé® Correction du formatage..."
	cargo fmt

check: check-rust ## V√©rification rapide de compilation
	@echo "üîß V√©rification de compilation..."
	cargo check

audit: check-rust ## Audit de s√©curit√©
	@echo "üõ°Ô∏è  Audit de s√©curit√©..."
	@if ! command -v cargo-audit >/dev/null 2>&1; then \
		echo "üì• Installation de cargo-audit..."; \
		cargo install cargo-audit; \
	fi
	cargo audit

ci: lint fmt test audit ## Pipeline CI compl√®te
	@echo "‚úÖ Pipeline CI termin√©e avec succ√®s"

# =============================================================================
# DOCUMENTATION ET UTILITAIRES
# =============================================================================

doc: check-rust ## G√©n√©rer la documentation
	@echo "üìö G√©n√©ration de la documentation..."
	cargo doc --no-deps --document-private-items --open

clean: ## Nettoyer les fichiers de build
	cargo clean

run: check-rust ## Compiler et ex√©cuter
	cargo run

install: build ## Installer le binaire dans ~/.cargo/bin
	cp target/release/$(BINARY_NAME) ~/.cargo/bin/

uninstall: ## D√©sinstaller le binaire de ~/.cargo/bin
	@echo "üóëÔ∏è  D√©sinstallation de $(BINARY_NAME)..."
	@if [ -f ~/.cargo/bin/$(BINARY_NAME) ]; then \
		rm ~/.cargo/bin/$(BINARY_NAME); \
		echo "‚úÖ $(BINARY_NAME) d√©sinstall√© avec succ√®s"; \
	else \
		echo "‚ö†Ô∏è  $(BINARY_NAME) n'est pas install√© dans ~/.cargo/bin"; \
	fi

release: check-rust ## Build optimis√© pour release
	@echo "üöÄ Building release $(BINARY_NAME) version $(VERSION)..."
	cargo build --release --target x86_64-unknown-linux-gnu

# Afficher les informations de version
version: ## Afficher les informations de version
	@echo "üìã Informations de version:"
	@echo "  Version: $(VERSION)"
	@echo "  Build time: $(BUILD_TIME_VAL)"
	@echo "  Git commit: $(GIT_COMMIT_VAL)"

status: ## Afficher le statut de l'environnement
	@echo "üìä Statut de l'environnement de d√©veloppement:"
	@echo "ü¶Ä Rust:"
	@echo "  Version: $(shell rustc --version 2>/dev/null || echo '‚ùå Non install√©')"
	@echo "  Cargo: $(shell cargo --version 2>/dev/null || echo '‚ùå Non install√©')"
	@echo "üéØ Targets install√©es:"
	@rustup target list --installed 2>/dev/null | sed 's/^/  /' || echo "  ‚ùå rustup non disponible"
	@echo "üîß Composants:"
	@rustup component list --installed 2>/dev/null | sed 's/^/  /' || echo "  ‚ùå rustup non disponible"
	@echo "üõ†Ô∏è  Outils additionnels:"
	@echo "  cargo-audit: $(shell command -v cargo-audit >/dev/null 2>&1 && echo '‚úÖ Install√©' || echo '‚ùå Non install√©')"
	@echo "  cargo-tarpaulin: $(shell command -v cargo-tarpaulin >/dev/null 2>&1 && echo '‚úÖ Install√©' || echo '‚ùå Non install√©')"
	@echo "ü™ü Cross-compilation Windows:"
	@echo "  mingw-w64: $(shell command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1 && echo '‚úÖ Install√©' || echo '‚ùå Non install√©')"

help: ## Afficher cette aide
	@echo "üõ†Ô∏è  Makefile pour $(BINARY_NAME)"
	@echo ""
	@echo "üìã Commandes disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "üöÄ Commandes de d√©marrage rapide:"
	@echo "  make setup-dev          # Installation compl√®te de l'environnement"
	@echo "  make build-all          # Build Linux + Windows"
	@echo "  make ci                 # Pipeline compl√®te (lint + test + audit)"
	@echo ""
	@echo "üìä Commandes d'information:"
	@echo "  make status             # Statut de l'environnement"
	@echo "  make version            # Informations de version"
