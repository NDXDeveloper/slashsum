# .github/workflows/build.yml - Version corrigÃ©e pour slashsum
name: Build Slashsum Multi-Platform

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Test et build de base
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    # cargo clippy -- -D warnings
    - name: Run tests
      run: |
        cargo test

        cargo fmt -- --check

    - name: Build and test binary
      run: |
        make build
        echo "=== Binary info ==="
        ls -la target/release/slashsum
        file target/release/slashsum

        echo "=== Version test ==="
        ./target/release/slashsum --version

        echo "=== Functional test ==="
        echo "Hello World" > test.txt
        ./target/release/slashsum test.txt
        rm test.txt

  # Build Linux
  build-linux:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build Linux binary
      run: |
        make build

    - name: Create portable package
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}

        # Create package directory
        mkdir -p slashsum-linux-amd64-portable

        # Copy binary
        cp target/release/slashsum slashsum-linux-amd64-portable/

        # Copy documentation
        cp LICENSE slashsum-linux-amd64-portable/
        cp README.md slashsum-linux-amd64-portable/

        # Create install script
        cat > slashsum-linux-amd64-portable/install.sh << 'EOF'
        #!/bin/bash
        # Slashsum Installation Script for Linux

        set -e

        INSTALL_DIR="/usr/local/bin"
        SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

        echo "ðŸ” Slashsum Installer for Linux"
        echo "================================"
        echo ""

        # Check if running with sudo for system-wide install
        if [ "$EUID" -ne 0 ]; then
            echo "âš ï¸  Not running as root. Will try to install to $INSTALL_DIR"
            echo "   If this fails, please run: sudo ./install.sh"
            echo ""
        fi

        # Check if binary exists
        if [ ! -f "$SCRIPT_DIR/slashsum" ]; then
            echo "âŒ Error: slashsum binary not found in $SCRIPT_DIR"
            exit 1
        fi

        # Make binary executable
        chmod +x "$SCRIPT_DIR/slashsum"

        # Create install directory if needed
        if [ ! -d "$INSTALL_DIR" ]; then
            echo "ðŸ“ Creating $INSTALL_DIR..."
            mkdir -p "$INSTALL_DIR"
        fi

        # Copy binary
        echo "ðŸ“¦ Installing slashsum to $INSTALL_DIR..."
        cp "$SCRIPT_DIR/slashsum" "$INSTALL_DIR/slashsum"
        chmod +x "$INSTALL_DIR/slashsum"

        # Verify installation
        if command -v slashsum &> /dev/null; then
            echo ""
            echo "âœ… Installation successful!"
            echo ""
            slashsum --version
            echo ""
            echo "ðŸš€ You can now use 'slashsum' from anywhere."
            echo "   Try: slashsum --help"
        else
            echo ""
            echo "âš ï¸  Binary installed but not in PATH."
            echo "   Add $INSTALL_DIR to your PATH or run:"
            echo "   $INSTALL_DIR/slashsum --help"
        fi
        EOF
        chmod +x slashsum-linux-amd64-portable/install.sh

        # Create uninstall script
        cat > slashsum-linux-amd64-portable/uninstall.sh << 'EOF'
        #!/bin/bash
        # Slashsum Uninstallation Script for Linux

        set -e

        INSTALL_DIR="/usr/local/bin"

        echo "ðŸ—‘ï¸  Slashsum Uninstaller for Linux"
        echo "=================================="
        echo ""

        if [ "$EUID" -ne 0 ]; then
            echo "âš ï¸  Not running as root. Will try to uninstall from $INSTALL_DIR"
            echo "   If this fails, please run: sudo ./uninstall.sh"
            echo ""
        fi

        if [ -f "$INSTALL_DIR/slashsum" ]; then
            rm "$INSTALL_DIR/slashsum"
            echo "âœ… Slashsum has been uninstalled successfully."
        else
            echo "âš ï¸  Slashsum is not installed in $INSTALL_DIR"
        fi
        EOF
        chmod +x slashsum-linux-amd64-portable/uninstall.sh

        # Create the archive
        tar -czvf slashsum-linux-amd64-portable.tar.gz slashsum-linux-amd64-portable/

        # Show contents
        echo "=== Package contents ==="
        tar -tzvf slashsum-linux-amd64-portable.tar.gz

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: slashsum-linux
        path: slashsum-linux-amd64-portable.tar.gz

  # Build Windows
  build-windows:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-gnu

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64-x86-64 zip

    - name: Build Windows binary
      run: |
        export CC_x86_64_pc_windows_gnu=x86_64-w64-mingw32-gcc
        export CXX_x86_64_pc_windows_gnu=x86_64-w64-mingw32-g++
        export AR_x86_64_pc_windows_gnu=x86_64-w64-mingw32-ar
        export CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc

        cargo build --release --target x86_64-pc-windows-gnu

    - name: Create portable package
      run: |
        # Create package directory
        mkdir -p slashsum-windows-amd64-portable

        # Copy binary
        cp target/x86_64-pc-windows-gnu/release/slashsum.exe slashsum-windows-amd64-portable/

        # Copy documentation
        cp LICENSE slashsum-windows-amd64-portable/
        cp README.md slashsum-windows-amd64-portable/

        # Create install script (batch)
        cat > slashsum-windows-amd64-portable/install.bat << 'EOF'
        @echo off
        :: Slashsum Installation Script for Windows
        :: Run as Administrator for system-wide installation

        echo ========================================
        echo  Slashsum Installer for Windows
        echo ========================================
        echo.

        set "INSTALL_DIR=%LOCALAPPDATA%\Slashsum"

        :: Check for admin rights
        net session >nul 2>&1
        if %errorLevel% == 0 (
            set "INSTALL_DIR=%ProgramFiles%\Slashsum"
            echo Running as Administrator - Installing to %INSTALL_DIR%
        ) else (
            echo Running as User - Installing to %INSTALL_DIR%
        )
        echo.

        :: Create install directory
        if not exist "%INSTALL_DIR%" (
            echo Creating directory: %INSTALL_DIR%
            mkdir "%INSTALL_DIR%"
        )

        :: Copy binary
        echo Copying slashsum.exe to %INSTALL_DIR%...
        copy /Y "%~dp0slashsum.exe" "%INSTALL_DIR%\slashsum.exe" >nul

        :: Add to PATH
        echo.
        echo Adding to PATH...
        setx PATH "%PATH%;%INSTALL_DIR%" >nul 2>&1

        echo.
        echo ========================================
        echo  Installation complete!
        echo ========================================
        echo.
        echo Please restart your terminal to use 'slashsum'.
        echo Or run: %INSTALL_DIR%\slashsum.exe --version
        echo.
        pause
        EOF

        # Create uninstall script (batch)
        cat > slashsum-windows-amd64-portable/uninstall.bat << 'EOF'
        @echo off
        :: Slashsum Uninstallation Script for Windows

        echo ========================================
        echo  Slashsum Uninstaller for Windows
        echo ========================================
        echo.

        set "INSTALL_DIR_USER=%LOCALAPPDATA%\Slashsum"
        set "INSTALL_DIR_SYSTEM=%ProgramFiles%\Slashsum"

        :: Try to remove from user location
        if exist "%INSTALL_DIR_USER%\slashsum.exe" (
            echo Removing from %INSTALL_DIR_USER%...
            del /Q "%INSTALL_DIR_USER%\slashsum.exe" 2>nul
            rmdir "%INSTALL_DIR_USER%" 2>nul
            echo Removed user installation.
        )

        :: Try to remove from system location (needs admin)
        if exist "%INSTALL_DIR_SYSTEM%\slashsum.exe" (
            echo Removing from %INSTALL_DIR_SYSTEM%...
            del /Q "%INSTALL_DIR_SYSTEM%\slashsum.exe" 2>nul
            rmdir "%INSTALL_DIR_SYSTEM%" 2>nul
            echo Removed system installation.
        )

        echo.
        echo ========================================
        echo  Uninstallation complete!
        echo ========================================
        echo.
        echo Note: You may need to manually remove Slashsum from your PATH.
        echo.
        pause
        EOF

        # Create the ZIP archive
        zip -r slashsum-windows-amd64-portable.zip slashsum-windows-amd64-portable/

        # Show contents
        echo "=== Package contents ==="
        unzip -l slashsum-windows-amd64-portable.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: slashsum-windows
        path: slashsum-windows-amd64-portable.zip

# Build Windows NSIS Installers (User + Admin)
  build-windows-installer:
    runs-on: ubuntu-latest
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Windows binary
      uses: actions/download-artifact@v4
      with:
        name: slashsum-windows

    - name: Extract Windows binary
      run: |
        unzip slashsum-windows-amd64-portable.zip
        cp slashsum-windows-amd64-portable/slashsum.exe slashsum-windows-amd64.exe
        ls -la *.exe

    - name: Install NSIS
      run: |
        sudo apt-get update
        sudo apt-get install -y nsis nsis-pluginapi

    - name: Create NSIS user installer script
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}

        # Extraire les composants de version (ex: 0.2.1 -> 0, 2, 1)
        IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
        PATCH=${VERSION_PARTS[3]:-0}
        MAJOR=${VERSION_PARTS[0]:-0}
        MINOR=${VERSION_PARTS[1]:-0}
        BUILD=${VERSION_PARTS[2]:-0}

        echo "Building USER installer for version: $VERSION (Major: $MAJOR, Minor: $MINOR, Build: $BUILD)"

        cat > installer_user.nsi << EOF

        ; Slashsum Installer - Version minimale sans macros
        ; Installation dans le profil utilisateur avec PATH utilisateur

        !define APPNAME "Slashsum"
        !define COMPANYNAME "NDXDeveloper"
        !define DESCRIPTION "Calculate multiple checksums simultaneously"
        !define VERSIONMAJOR $MAJOR
        !define VERSIONMINOR $MINOR
        !define VERSIONBUILD $BUILD
        !define VERSION "$VERSION"

        ; Configuration de l'installateur
        Name "${APPNAME}"
        OutFile "slashsum-setup-user.exe"

        ; Installation dans le profil utilisateur (pas besoin d'admin)
        InstallDir "\$LOCALAPPDATA\${COMPANYNAME}\${APPNAME}"

        ; Pas besoin de droits admin
        RequestExecutionLevel user

        ; MÃ©tadonnÃ©es de l'installateur
        VIProductVersion "$MAJOR.$MINOR.$BUILD.$PATCH"
        VIAddVersionKey "ProductName" "${APPNAME}"
        VIAddVersionKey "CompanyName" "${COMPANYNAME}"
        VIAddVersionKey "FileDescription" "${DESCRIPTION}"
        VIAddVersionKey "FileVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
        VIAddVersionKey "ProductVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
        VIAddVersionKey "LegalCopyright" "Â© ${COMPANYNAME}"

        ; Pages de l'installateur
        Page directory
        Page instfiles

        ; Section d'installation principal
        Section "install"
            ; CrÃ©er le rÃ©pertoire d'installation
            CreateDirectory "\$INSTDIR"

            ; Copier les fichiers
            SetOutPath "\$INSTDIR"
            File "slashsum-windows-amd64.exe"
            File /oname=slashsum.exe "slashsum-windows-amd64.exe"

            ; Ajouter au PATH utilisateur - mÃ©thode simple
            DetailPrint "Configuring user PATH..."
            ReadRegStr \$0 HKCU "Environment" "PATH"

            ; Si PATH est vide, ajouter juste notre chemin
            StrCmp \$0 "" 0 +3
            WriteRegStr HKCU "Environment" "PATH" "\$INSTDIR"
            Goto PathDone

            ; Sinon, ajouter Ã  la fin avec un point-virgule
            WriteRegStr HKCU "Environment" "PATH" "\$0;\$INSTDIR"

            PathDone:
            ; Notifier Windows du changement
            SendMessage 0xFFFF 0x001A 0 "STR:Environment" /TIMEOUT=5000
            DetailPrint "User PATH updated."

            ; CrÃ©er l'entrÃ©e de dÃ©sinstallation dans le registre utilisateur
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "\$INSTDIR\uninstall.exe"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "Publisher" "${COMPANYNAME}"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "InstallLocation" "\$INSTDIR"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayIcon" "\$INSTDIR\slashsum.exe"
            WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoModify" 1
            WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoRepair" 1
            WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "EstimatedSize" 3072

            ; CrÃ©er le dÃ©sinstallateur
            WriteUninstaller "\$INSTDIR\uninstall.exe"

            ; CrÃ©er un raccourci sur le bureau (optionnel)
            ;MessageBox MB_YESNO "CrÃ©er un raccourci sur le bureau ?" IDNO +2
            ;CreateShortcut "\$DESKTOP\${APPNAME}.lnk" "\$INSTDIR\slashsum.exe"

            ; CrÃ©er des raccourcis dans le menu dÃ©marrer
            ;c'est une application console donc pas besoin de ces raccourcis
            ;CreateDirectory "\$SMPROGRAMS\${APPNAME}"
            ;CreateShortcut "\$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk" "\$INSTDIR\slashsum.exe"
            ;CreateShortcut "\$SMPROGRAMS\${APPNAME}\DÃ©sinstaller ${APPNAME}.lnk" "\$INSTDIR\uninstall.exe"

            DetailPrint "Installation complete!"

            ; Message de fin
            MessageBox MB_YESNO|MB_ICONQUESTION "Installation complete! $\n$\nOpen a terminal to test 'slashsum'?$\n$\nNote: Restart your terminal if necessary." IDNO +2
            ExecShell "open" "cmd" "/k set PATH=%PATH%;\$INSTDIR && echo Slashsum installed ! && slashsum --help"
        SectionEnd

        ; Section de dÃ©sinstallation
        Section "uninstall"
            ; Supprimer du PATH utilisateur - mÃ©thode simple
            DetailPrint "Cleaning up the user PATH..."
            ReadRegStr \$0 HKCU "Environment" "PATH"

            ; Remplacer les occurrences de notre chemin
            ; Note: Cette mÃ©thode simple peut laisser des point-virgules orphelins
            ; mais c'est acceptable pour un installateur basique

            ; Supprimer les fichiers
            Delete "\$INSTDIR\slashsum.exe"
            Delete "\$INSTDIR\slashsum-windows-amd64.exe"
            Delete "\$INSTDIR\uninstall.exe"

            ; Supprimer les raccourcis
            ;Delete "\$DESKTOP\${APPNAME}.lnk"
            ;Delete "\$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
            ;Delete "\$SMPROGRAMS\${APPNAME}\DÃ©sinstaller ${APPNAME}.lnk"
            RMDir "\$SMPROGRAMS\${APPNAME}"

            ; Supprimer le rÃ©pertoire d'installation
            RMDir "\$INSTDIR"

            ; Supprimer l'entrÃ©e de dÃ©sinstallation
            DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"

            DetailPrint "Uninstallation complete! "

            MessageBox MB_ICONINFORMATION "Uninstallation complete! $\n$\nNote: You can restart your terminal to clean up the PATH."
        SectionEnd
        EOF

    - name: Create NSIS admin installer script
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}

        # Extraire les composants de version
        IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
        PATCH=${VERSION_PARTS[3]:-0}
        MAJOR=${VERSION_PARTS[0]:-0}
        MINOR=${VERSION_PARTS[1]:-0}
        BUILD=${VERSION_PARTS[2]:-0}

        echo "Building ADMIN installer for version: $VERSION (Major: $MAJOR, Minor: $MINOR, Build: $BUILD)"

        cat > installer_admin.nsi << EOF

        ; Slashsum Installer - Version Admin ultra-simple
        ; Installation systÃ¨me avec droits administrateur

        !define APPNAME "Slashsum CLI"
        !define COMPANYNAME "NDXDeveloper"
        !define DESCRIPTION "Calculate multiple checksums simultaneously"
        !define VERSIONMAJOR $MAJOR
        !define VERSIONMINOR $MINOR
        !define VERSIONBUILD $BUILD
        !define VERSION "$VERSION"
        !define HELPURL "https://github.com/NDXDeveloper/slashsum"
        !define UPDATEURL "https://github.com/NDXDeveloper/slashsum/releases"
        !define ABOUTURL "https://github.com/NDXDeveloper/slashsum"

        ; Configuration de l'installateur
        Name "${APPNAME}"
        OutFile "slashsum-setup-admin.exe"

        ; Installation dans Program Files (nÃ©cessite admin)
        InstallDir "\$PROGRAMFILES64\${COMPANYNAME}\${APPNAME}"

        ; Droits admin requis
        RequestExecutionLevel admin

        ; MÃ©tadonnÃ©es de l'installateur
        VIProductVersion "$MAJOR.$MINOR.$BUILD.$PATCH"
        VIAddVersionKey "ProductName" "${APPNAME}"
        VIAddVersionKey "CompanyName" "${COMPANYNAME}"
        VIAddVersionKey "FileDescription" "${DESCRIPTION}"
        VIAddVersionKey "FileVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
        VIAddVersionKey "ProductVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
        VIAddVersionKey "LegalCopyright" "Â© ${COMPANYNAME}"

        ; Pages de l'installateur
        Page directory
        Page instfiles

        ; Section d'installation principal
        Section "install"
            ; CrÃ©er le rÃ©pertoire d'installation
            CreateDirectory "\$INSTDIR"

            ; Copier les fichiers
            SetOutPath "\$INSTDIR"
            File "slashsum-windows-amd64.exe"
            File /oname=slashsum.exe "slashsum-windows-amd64.exe"

            ; Ajouter au PATH systÃ¨me - mÃ©thode brutale mais qui marche
            DetailPrint "Configuring system PATH..."
            ReadRegStr \$0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "PATH"

            ; Ajouter notre chemin (mÃªme s'il existe dÃ©jÃ , pas grave)
            StrCmp \$0 "" 0 +3
            WriteRegStr HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "PATH" "\$INSTDIR"
            Goto PathDone
            WriteRegStr HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "PATH" "\$0;\$INSTDIR"

            PathDone:
            ; Notifier Windows du changement
            SendMessage 0xFFFF 0x001A 0 "STR:Environment" /TIMEOUT=5000
            DetailPrint "System PATH updated."

            ; CrÃ©er l'entrÃ©e de dÃ©sinstallation
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "\$INSTDIR\uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "Publisher" "${COMPANYNAME}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "InstallLocation" "\$INSTDIR"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayIcon" "\$INSTDIR\slashsum.exe"
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoModify" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoRepair" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "EstimatedSize" 3072

            ; CrÃ©er le dÃ©sinstallateur
            WriteUninstaller "\$INSTDIR\uninstall.exe"

            DetailPrint "Installation complete!"

            ; Message de fin
            MessageBox MB_YESNO|MB_ICONQUESTION "Installation terminÃ©e !$\n$\nOpen a terminal to test 'slashsum'?$\n$\nNote: Restart your terminal if necessary." IDNO +2
            ExecShell "open" "cmd" "/k set PATH=%PATH%;\$INSTDIR && echo Slashsum CLI installed ! && slashsum --help"
        SectionEnd

        ; Section de dÃ©sinstallation
        Section "uninstall"
            ; Note: On ne nettoie pas le PATH systÃ¨me pour Ã©viter les erreurs
            ; L'utilisateur peut le faire manuellement si nÃ©cessaire
            DetailPrint "Cleaning up files..."

            ; Supprimer les fichiers
            Delete "\$INSTDIR\slashsum.exe"
            Delete "\$INSTDIR\slashsum-windows-amd64.exe"
            Delete "\$INSTDIR\uninstall.exe"

            ; Supprimer le rÃ©pertoire d'installation
            RMDir "\$INSTDIR"

            ; Supprimer l'entrÃ©e de dÃ©sinstallation
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"

            DetailPrint "Uninstallation complete!"
            MessageBox MB_ICONINFORMATION "Uninstallation complete!$\n$\nNote: You can restart your terminal to clean up the PATH."
        SectionEnd

        EOF

    - name: Build NSIS installers
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}

        # Compiler l'installeur utilisateur
        echo "Building user installer..."
        makensis installer_user.nsi

        # Compiler l'installeur admin
        echo "Building admin installer..."
        makensis installer_admin.nsi

        # Renommer avec la version
        mv slashsum-setup-user.exe slashsum-setup-user-${TAG_NAME}.exe
        mv slashsum-setup-admin.exe slashsum-setup-admin-${TAG_NAME}.exe

        # VÃ©rifier les fichiers crÃ©Ã©s
        echo "Created installers:"
        ls -la *.exe
        file slashsum-setup-user-${TAG_NAME}.exe
        file slashsum-setup-admin-${TAG_NAME}.exe

    - name: Upload NSIS installers
      uses: actions/upload-artifact@v4
      with:
        name: slashsum-installers
        path: slashsum-setup-*.exe

  # Build macOS
  build-macos:
    runs-on: macos-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build macOS binary
      run: |
        make build

    - name: Create portable package
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}

        # Create package directory
        mkdir -p slashsum-darwin-amd64-portable

        # Copy binary
        cp target/release/slashsum slashsum-darwin-amd64-portable/

        # Copy documentation
        cp LICENSE slashsum-darwin-amd64-portable/
        cp README.md slashsum-darwin-amd64-portable/

        # Create install script
        cat > slashsum-darwin-amd64-portable/install.sh << 'EOF'
        #!/bin/bash
        # Slashsum Installation Script for macOS

        set -e

        INSTALL_DIR="/usr/local/bin"
        SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

        echo "ðŸ” Slashsum Installer for macOS"
        echo "================================"
        echo ""

        # Check if running with sudo for system-wide install
        if [ "$EUID" -ne 0 ]; then
            echo "âš ï¸  Not running as root. Will try to install to $INSTALL_DIR"
            echo "   If this fails, please run: sudo ./install.sh"
            echo ""
        fi

        # Check if binary exists
        if [ ! -f "$SCRIPT_DIR/slashsum" ]; then
            echo "âŒ Error: slashsum binary not found in $SCRIPT_DIR"
            exit 1
        fi

        # Make binary executable
        chmod +x "$SCRIPT_DIR/slashsum"

        # Create install directory if needed
        if [ ! -d "$INSTALL_DIR" ]; then
            echo "ðŸ“ Creating $INSTALL_DIR..."
            mkdir -p "$INSTALL_DIR"
        fi

        # Copy binary
        echo "ðŸ“¦ Installing slashsum to $INSTALL_DIR..."
        cp "$SCRIPT_DIR/slashsum" "$INSTALL_DIR/slashsum"
        chmod +x "$INSTALL_DIR/slashsum"

        # Verify installation
        if command -v slashsum &> /dev/null; then
            echo ""
            echo "âœ… Installation successful!"
            echo ""
            slashsum --version
            echo ""
            echo "ðŸš€ You can now use 'slashsum' from anywhere."
            echo "   Try: slashsum --help"
        else
            echo ""
            echo "âš ï¸  Binary installed but not in PATH."
            echo "   Add $INSTALL_DIR to your PATH or run:"
            echo "   $INSTALL_DIR/slashsum --help"
        fi
        EOF
        chmod +x slashsum-darwin-amd64-portable/install.sh

        # Create uninstall script
        cat > slashsum-darwin-amd64-portable/uninstall.sh << 'EOF'
        #!/bin/bash
        # Slashsum Uninstallation Script for macOS

        set -e

        INSTALL_DIR="/usr/local/bin"

        echo "ðŸ—‘ï¸  Slashsum Uninstaller for macOS"
        echo "=================================="
        echo ""

        if [ "$EUID" -ne 0 ]; then
            echo "âš ï¸  Not running as root. Will try to uninstall from $INSTALL_DIR"
            echo "   If this fails, please run: sudo ./uninstall.sh"
            echo ""
        fi

        if [ -f "$INSTALL_DIR/slashsum" ]; then
            rm "$INSTALL_DIR/slashsum"
            echo "âœ… Slashsum has been uninstalled successfully."
        else
            echo "âš ï¸  Slashsum is not installed in $INSTALL_DIR"
        fi
        EOF
        chmod +x slashsum-darwin-amd64-portable/uninstall.sh

        # Create the archive
        tar -czvf slashsum-darwin-amd64-portable.tar.gz slashsum-darwin-amd64-portable/

        # Show contents
        echo "=== Package contents ==="
        tar -tzvf slashsum-darwin-amd64-portable.tar.gz

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: slashsum-macos
        path: slashsum-darwin-amd64-portable.tar.gz

  # Build Snap
  build-snap:
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build Snap
      uses: snapcore/action-build@v1
      id: build-snap

    - name: Rename snap file
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        mv *.snap slashsum_${TAG_NAME}_amd64.snap

    - name: Upload Snap artifact
      uses: actions/upload-artifact@v4
      with:
        name: slashsum-snap
        path: slashsum_*.snap

    - name: Upload Snap Store assets
      uses: actions/upload-artifact@v4
      with:
        name: snap-store-assets
        path: |
          store-assets/icon.png
          store-assets/banner.png
          store-assets/screenshots/

  # Build DEB package
  build-deb:
    runs-on: ubuntu-latest
    needs: build-linux
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: slashsum-linux

    - name: Install nfpm
      run: |
        wget https://github.com/goreleaser/nfpm/releases/download/v2.43.0/nfpm_2.43.0_amd64.deb
        sudo dpkg -i nfpm_2.43.0_amd64.deb

    - name: Build DEB package
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}

        # Extract binary from portable archive
        tar -xzvf slashsum-linux-amd64-portable.tar.gz

        # Create target structure
        mkdir -p target/release
        cp slashsum-linux-amd64-portable/slashsum target/release/slashsum
        chmod +x target/release/slashsum

        cat > nfpm.yaml << EOF
        name: "slashsum"
        arch: "amd64"
        platform: "linux"
        version: "${VERSION}"
        section: "utils"
        priority: "optional"
        maintainer: "Nicolas DEOUX <NDXDev@gmail.com>"
        description: |
          Calculate multiple checksums simultaneously
          Fast tool for calculating CRC32, MD5, SHA1, SHA256, and SHA512 checksums.
        vendor: "NDXDev"
        homepage: "https://github.com/NDXDeveloper/slashsum"
        license: "MIT"
        depends:
          - libc6
        contents:
          - src: "./target/release/slashsum"
            dst: "/usr/bin/slashsum"
            file_info:
              mode: 0755
          - src: "./README.md"
            dst: "/usr/share/doc/slashsum/README.md"
            file_info:
              mode: 0644
        EOF

        nfpm pkg --packager deb --config nfpm.yaml --target slashsum_${TAG_NAME}_amd64.deb

        chmod a+r slashsum_${TAG_NAME}_amd64.deb

        ls -la *.deb
        rm nfpm_2.43.0_amd64.deb

    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: slashsum-deb
        path: slashsum_*.deb

  # Release finale (seulement pour les tags)
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows, build-windows-installer, build-macos, build-snap, build-deb]
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Prepare release files
      run: |
        # Organiser tous les fichiers
        echo "=== All downloaded artifacts ==="
        find . -name "slashsum*" -type f | head -20

        # CrÃ©er le dossier de release
        mkdir -p release

        # Copier tous les binaires et packages
        echo "=== Copying release files ==="
        cp INSTALL release/ 2>/dev/null || true
        cp slashsum-linux/slashsum-linux-amd64-portable.tar.gz release/ 2>/dev/null || true
        cp slashsum-windows/slashsum-windows-amd64-portable.zip release/ 2>/dev/null || true
        cp slashsum-installers/slashsum-setup-user-*.exe release/ 2>/dev/null || echo "No User installer"
        cp slashsum-installers/slashsum-setup-admin-*.exe release/ 2>/dev/null || echo "No Admin installer"
        cp slashsum-macos/slashsum-darwin-amd64-portable.tar.gz release/ 2>/dev/null || true
        cp slashsum-snap/*.snap release/ 2>/dev/null || true
        cp slashsum-deb/*.deb release/ 2>/dev/null || true

        echo "=== Final release files ==="
        ls -la release/

        echo "=== File details ==="
        file release/* 2>/dev/null || echo "No files to analyze"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: release/*
        generate_release_notes: true
        body: |
          ## ðŸš€ Slashsum ${{ github.ref_name }}

          Calculate multiple checksums simultaneously with parallel processing.

          ### ðŸ“¦ Downloads

          #### Documentation
          - **ðŸ“– INSTALL**: Complete installation guide for all platforms

          #### Portable packages (includes install script, LICENSE, README)
          - **ðŸ§ Linux**: `slashsum-linux-amd64-portable.tar.gz`
          - **ðŸªŸ Windows**: `slashsum-windows-amd64-portable.zip`
          - **ðŸŽ macOS**: `slashsum-darwin-amd64-portable.tar.gz`

          #### Windows Installers
          - **ðŸ‘¤ User Installer**: `slashsum-setup-user-${{ github.ref_name }}.exe` (no admin rights required)
          - **ðŸ” Admin Installer**: `slashsum-setup-admin-${{ github.ref_name }}.exe` (system-wide installation)

          #### Linux Packages
          - **ðŸ“¦ Snap**: `slashsum_${{ github.ref_name }}_amd64.snap`
          - **ðŸ“‹ DEB**: `slashsum_${{ github.ref_name }}_amd64.deb`

          ### ðŸ› ï¸ Installation

          #### Windows (Recommended - Installers)

          **ðŸ‘¤ User installation (no admin required):**
          ```bash
          # Download and double-click to install
          # Installs to %LOCALAPPDATA%\Slashsum
          # Available only for current user
          ```

          **ðŸ” System installation (admin required):**
          ```bash
          # Download and right-click â†’ "Run as administrator"
          # Installs to C:\Program Files\Slashsum
          # Available for all system users
          ```

          #### Windows (Portable)
          ```powershell
          # Extract the ZIP archive
          Expand-Archive slashsum-windows-amd64-portable.zip -DestinationPath .
          cd slashsum-windows-amd64-portable

          # Run install script (or right-click > Run as administrator)
          .\install.bat

          # Or manual: copy slashsum.exe to a folder in your PATH
          ```

          #### Ubuntu/Debian (DEB)
          ```bash
          wget https://github.com/NDXDeveloper/slashsum/releases/download/${{ github.ref_name }}/slashsum_${{ github.ref_name }}_amd64.deb
          sudo apt install ./slashsum_${{ github.ref_name }}_amd64.deb
          hash -r
          slashsum --version
          ```

          #### Linux (Snap Store - Recommended)
          ```bash
          sudo snap install slashsum
          sudo snap connect slashsum:home
          sudo snap connect slashsum:removable-media
          hash -r  # Refresh shell path cache
          slashsum --version
          ```

          #### Linux (Snap from GitHub Release)
          ```bash
          wget https://github.com/NDXDeveloper/slashsum/releases/download/${{ github.ref_name }}/slashsum_${{ github.ref_name }}_amd64.snap
          sudo snap install --dangerous slashsum_${{ github.ref_name }}_amd64.snap
          sudo snap connect slashsum:home
          sudo snap connect slashsum:removable-media
          hash -r  # Refresh shell path cache
          slashsum --version
          ```

          #### macOS
          ```bash
          # Download and extract
          tar -xzvf slashsum-darwin-amd64-portable.tar.gz
          cd slashsum-darwin-amd64-portable

          # Run the install script
          sudo ./install.sh

          # Or manual installation
          chmod +x slashsum
          sudo mv slashsum /usr/local/bin/
          ```

          #### Linux (Portable)
          ```bash
          # Download and extract
          tar -xzvf slashsum-linux-amd64-portable.tar.gz
          cd slashsum-linux-amd64-portable

          # Run the install script
          sudo ./install.sh

          # Or manual installation
          chmod +x slashsum
          sudo mv slashsum /usr/local/bin/
          ```

          ### âœ¨ Features
          - **Algorithms**: CRC32, MD5, SHA1, SHA256, SHA512
          - **Parallel processing** for optimal performance
          - **Chunked reading** for large files
          - **Save results** with `--save` option
          - **Cross-platform**: Linux, Windows, macOS

          ### ðŸš€ Usage
          ```bash
          # Calculate checksums
          slashsum file.txt

          # Save to .checksum file
          slashsum file.txt --save

          # Show help
          slashsum --help

          # Show version
          slashsum --version
          ```

          ### ðŸ”§ Technical Details
          - **Binary size**: ~650KB
          - **Dependencies**: None (static binary)
          - **License**: MIT
          - **Architecture**: x86_64 only

          ### ðŸ“‹ Checksums
          All binaries are built from the same source code with version `${{ github.ref_name }}`.
          You can verify integrity by comparing checksums between platforms.

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
